::: {.content-hidden}
Copyright (C) 2024 Martin Köhler and co-authors (martin.koehler@jku.at)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
:::

# Comparison KPEX/2.5D with MAGIC {#sec-test-patterns}

The initial goal of `KPEX/2.5D` is to basically come up with the same results as `KPEX/MAGIC`.

::: {.callout-note}
Notes about this comparison:

- Version `Magic 8.3 rev 486` is used, but augmented with debug logging[^magic-with-debug-logging], which will be shown and discussed for each example.
- `KPEX/MAGIC` halo is set to `--magic_halo=100000`
   - NOTE: the screenshots however were created with `--magic_halo=8` to give better illustrations
- `KPEX/2.5D` halo is set to `--halo=100000`
:::


## Test Pattern `single_plate_100um_x_100um_li1_over_substrate`

GDS: <https://github.com/martinjankoehler/klayout-pex/blob/main/testdata/designs/sky130A/test_patterns/single_plate_100um_x_100um_li1_over_substrate.gds.gz>

{{< include /figures/test_patterns/single_plate_100um_x_100um_li1_over_substrate_-_overlap.qmd >}}

| Description | Layer Top | Net Top | Layer Bottom  | Net Bottom | MAGIC [fF]| KPEX/2.5D [fF]| MAGIC Lines |
|-------------|----------:|:--------|--------------:|:----------:|----------:|--------------:|------------:|
| Overlap     |       li1 | li1     |     substrate | VSUBS      |     369.9 |         369.9 |           4 |
: Extracted Parasitic Overlap Capacitances

{{< include /figures/test_patterns/single_plate_100um_x_100um_li1_over_substrate_-_perimeter.qmd >}}


| Description     | Layer Top | Net Top | Layer Bottom  | Net Bottom | MAGIC [fF]| KPEX/2.5D [fF]| MAGIC Lines |
|-----------------|----------:|:--------|--------------:|:----------:|----------:|--------------:|------------:|
| Fringe (top)    |       li1 | li1     |     substrate | VSUBS      |      4.07 |          4.07 |          5  |
| Fringe (left)   |       li1 | li1     |     substrate | VSUBS      |      4.07 |          4.07 |          6  |
| Fringe (right)  |       li1 | li1     |     substrate | VSUBS      |      4.07 |          4.07 |          7  |
| Fringe (bottom) |       li1 | li1     |     substrate | VSUBS      |      4.07 |          4.07 |          8  |


---
code-line-numbers: true
---
```{csv}
Magic 8.3 revision 486 - Compiled on `date`.
----------------------------------------------------

CapDebug (extNodeAreaFunc/Area) layer li(90), net li_0_0#, area=400000000 (10000 µm^2) nreg_cap += 369.9 fF
CapDebug (extNodeAreaFunc/Perimeter/TopSide) layer li(90), net li_0_0#, length=20000 (100 µm), nreg_cap += 4.07 fF (now nreg_cap = 373.97 fF)
CapDebug (extNodeAreaFunc/Perimeter/LeftSide) layer li(90), net li_0_0#, length=20000 (100 µm), nreg_cap += 4.07 fF (now nreg_cap = 378.04 fF)
CapDebug (extNodeAreaFunc/Perimeter/BottomSide) layer li(90), net li_0_0#, length=20000 (100 µm), nreg_cap += 4.07 fF (now nreg_cap = 382.11 fF)
CapDebug (extNodeAreaFunc/Perimeter/RightSide) layer li(90), net li_0_0#, length=20000 (100 µm), nreg_cap += 4.07 fF (now nreg_cap = 386.18 fF)
CapDebug (extSetResist): li_0_0# area=400000000 (10000 µm^2) perim=80000 (400 µm)
CapDebug ---
```


## Test Pattern `sidewall_20um_length_distance_200nm_li1`

GDS: <https://github.com/martinjankoehler/klayout-pex/blob/main/testdata/designs/sky130A/test_patterns/sidewall_20um_length_distance_200nm_li1.gds.gz>

{{< include /figures/test_patterns/sidewall_20um_length_distance_200nm_li1_-_overlap.qmd >}}

| Description | Layer Top | Net Top | Layer Bottom  | Net Bottom | MAGIC [fF]| KPEX/2.5D [fF]| MAGIC Lines |
|-------------|----------:|:--------|--------------:|:----------:|----------:|--------------:|------------:|
| Overlap     |       li1 | A       |     substrate | VSUBS      |    0.7398 |          0.74 |          4  |
| Overlap     |       li1 | B       |     substrate | VSUBS      |    0.7398 |          0.74 |          11 |
: Extracted Parasitic Overlap Capacitances


{{< include /figures/test_patterns/sidewall_20um_length_distance_200nm_li1_-_sidewall.qmd >}}

| Description | Layer | Net1 | Net2 | MAGIC [fF]| KPEX/2.5D [fF]| MAGIC Lines |
|-------------|------:|:----:|-----:|----------:|--------------:|------------:|
| Sidewall    |   li1 | A    |    B |      0.75 |          0.75 |          18 |
| Sidewall    |   li1 | B    |    A |      0.75 |          0.75 |          21 |
: Extracted Parasitic Sidewall Capacitances

{{< include /figures/test_patterns/sidewall_20um_length_distance_200nm_li1_-_fringe_A.qmd >}}

| Description     | Layer Top | Net Top | Layer Bottom  | Net Bottom | MAGIC [fF]| KPEX/2.5D [fF]| MAGIC Lines |
|-----------------|----------:|:--------|--------------:|:----------:|----------:|--------------:|------------:|
| Fringe (top)    |       li1 | A       |     substrate | VSUBS      |     0.814 |         0.814 |           5 |
| Fringe (left)   |       li1 | A       |     substrate | VSUBS      |    0.0407 |         0.041 |           6 |
| Fringe (bottom) |       li1 | A       |     substrate | VSUBS      |     0.814 |         0.076 |           7 |
| Fringe (bottom) |       li1 | A       |     substrate | VSUBS      |   -0.7379 |           --- |          19 |
| Fringe (right)  |       li1 | A       |     substrate | VSUBS      |    0.0407 |         0.041 |           8 |
| Fringe (top)    |       li1 | B       |     substrate | VSUBS      |     0.814 |         0.076 |          12 |
| Fringe (top)    |       li1 | B       |     substrate | VSUBS      |   -0.7379 |           --- |          22 |
| Fringe (left)   |       li1 | B       |     substrate | VSUBS      |    0.0407 |         0.041 |          13 |
| Fringe (bottom) |       li1 | B       |     substrate | VSUBS      |     0.814 |         0.814 |          14 |
| Fringe (right)  |       li1 | B       |     substrate | VSUBS      |    0.0407 |         0.041 |          15 |
: Extracted Parasitic Fringe Capacitances between nets A, B on li1 and substrate


---
code-line-numbers: true
---
```{csv}
Magic 8.3 revision 486 - Compiled on `date`.
----------------------------------------------------

CapDebug (extNodeAreaFunc/Area) layer li(90), net li_0_240#, area=800000 (20 µm^2) nreg_cap += 0.7398 fF
CapDebug (extNodeAreaFunc/Perimeter/TopSide) layer li(90), net li_0_240#, length=4000 (20 µm), nreg_cap += 0.814 fF (now nreg_cap = 1.5538 fF)
CapDebug (extNodeAreaFunc/Perimeter/LeftSide) layer li(90), net li_0_240#, length=200 (1 µm), nreg_cap += 0.0407 fF (now nreg_cap = 1.5945 fF)
CapDebug (extNodeAreaFunc/Perimeter/BottomSide) layer li(90), net li_0_240#, length=4000 (20 µm), nreg_cap += 0.814 fF (now nreg_cap = 2.4085 fF)
CapDebug (extNodeAreaFunc/Perimeter/RightSide) layer li(90), net li_0_240#, length=200 (1 µm), nreg_cap += 0.0407 fF (now nreg_cap = 2.4492 fF)
CapDebug (extSetResist): li_0_240# area=800000 (20 µm^2) perim=8400 (42 µm)
CapDebug ---
CapDebug (extNodeAreaFunc/Area) layer li(90), net li_0_0#, area=800000 (20 µm^2) nreg_cap += 0.7398 fF
CapDebug (extNodeAreaFunc/Perimeter/TopSide) layer li(90), net li_0_0#, length=4000 (20 µm), nreg_cap += 0.814 fF (now nreg_cap = 1.5538 fF)
CapDebug (extNodeAreaFunc/Perimeter/LeftSide) layer li(90), net li_0_0#, length=200 (1 µm), nreg_cap += 0.0407 fF (now nreg_cap = 1.5945 fF)
CapDebug (extNodeAreaFunc/Perimeter/BottomSide) layer li(90), net li_0_0#, length=4000 (20 µm), nreg_cap += 0.814 fF (now nreg_cap = 2.4085 fF)
CapDebug (extNodeAreaFunc/Perimeter/RightSide) layer li(90), net li_0_0#, length=200 (1 µm), nreg_cap += 0.0407 fF (now nreg_cap = 2.4492 fF)
CapDebug (extSetResist): li_0_0# area=800000 (20 µm^2) perim=8400 (42 µm)
CapDebug ---
CapDebug (sidewall): A-B (layer li), overlap=4000 (20 µm), sep=40 (0.2 µm), e->ec_cap=12.75 (0.0255 fF), e->ec_offset=28 (0.14 µm), delta += 0.75 fF …	now is 0.75 fF
CapDebug (obsolete_fringe (blocked)): A -= 0.737881 fF …	now A == 1.711319 fF
	overlapMult=0.003699 (3.699 aF/µm^2) dnear=40 (0.2 µm), snear=0.0935129 (0.000467564 µm), perimCap[90][0]=0.2035 (40.7 /µm), length=4000 (20 µm)
CapDebug (sidewall): A-B (layer li), overlap=4000 (20 µm), sep=40 (0.2 µm), e->ec_cap=12.75 (0.0255 fF), e->ec_offset=28 (0.14 µm), delta += 0.75 fF …	now is 1.5 fF
CapDebug (obsolete_fringe (blocked)): B -= 0.737881 fF …	now B == 1.711319 fF
	overlapMult=0.003699 (3.699 aF/µm^2) dnear=40 (0.2 µm), snear=0.0935129 (0.000467564 µm), perimCap[90][0]=0.2035 (40.7 /µm), length=4000 (20 µm)
exttospice finished.
```
